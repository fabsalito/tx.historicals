@{
    Layout = null;
}

@{
    if (@ViewBag.outside)
    {
// incluir estilos
<link href="@Url.Content("~/Content/jquery-ui/jquery-ui-1.9.2.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/Estandar/layout.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/Estandar/estandar.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/Estandar/fixedTable.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/alarms.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/jquery.dataTables/css/jquery.dataTablesTernium.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/jquery.dataTables/css/jquery.dataTables_themerollerTernium.css")" rel="stylesheet" type="text/css" />
<script type="type="text/css"">
    #tbHistorical td{
        font-size: 11;
        font-family: "verdana";
    }
</script>

<div id="divDialogAlarmInfo" title="Información de alarma" class="dialogGeneral" style="text-align: center;">

</div>
    }
}

<table id="tbHistorical">
    <thead>
        <tr>
            <th>EST.</th>
            <th>[CODIGO] DESCRIPCIÓN</th>
            <th>TIEMPO ON</th>
            <th>TIEMPO OFF</th>

            <th>TIEMPO ACEPT.</th>
            <th>TIEMPO RESET</th>
            <th>TIEMPO CUARE.</th>

            <th>CAUSA</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td colspan="8" ></td>
        </tr>
    </tbody>
</table>



<input id="hidIdLineaGrid" value="@ViewBag.idLinea" type="hidden" />
<input id="hidFiltroDescripcionGrid" value="@ViewBag.description" type="hidden" />
<input id="hidFiltroSistemaGrid" value="@ViewBag.system" type="hidden" />
<input id="hidFiltroNodeGrid" value="@ViewBag.node" type="hidden" />
<input id="hidFiltroDireccionGrid" value="@ViewBag.address" type="hidden" />
<input id="hidFiltroCodigoGrid" value="@ViewBag.code" type="hidden" />
<input id="hidFiltroDiaInicioGrid" value="@ViewBag.inicio" type="hidden" />
<input id="hidFiltroDiaFinGrid" value="@ViewBag.fin" type="hidden" />
<input id="hidEstadosChckBx1Grid" value="@ViewBag.showAusNoRec" type="hidden" />
<input id="hidEstadosChckBx2Grid" value="@ViewBag.showPreNoRec" type="hidden" />
<input id="hidEstadosChckBx3Grid" value="@ViewBag.showPreRec" type="hidden" />
<input id="hidEventosChckBx1Grid" value="@ViewBag.showEvents" type="hidden" />
<input id="hidFiltroDisplayLengthGrid" value="@ViewBag.iDisplayLength" type="hidden" />
<input id="hidUrlAlarmInfoGrid" type="hidden" value="@Url.Action("VerAlarmInfo", "Alarm")" />
@{
    if (@ViewBag.outside){
        
// incluir scripts de pagina completa
<script src="@Url.Content("~/Scripts/jquery-1.8.3.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery-ui-1.9.2.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/modernizr-1.7.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.dataTables/jquery.dataTablesTernium.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.dataTables/jquery.dataTablesTerniumExt.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/JsonAsynchronousCallback.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/json2.js")" type="text/javascript"></script>
<script type="text/javascript">
    var dialogAlarmInfo;

    function dataTableRezize() {
        $('.dataTables_scrollBody').css('height', $(window).height() - ($('.dataTables_filter').height() * 2) - $('.dataTables_info').height() - $('.dataTables_scrollHead').height());
    }

    function VerAlarmInfo(idAlarm, timeOn) {
        var params;
        var url = $("#hidUrlAlarmInfoGrid").val();
        var idLinea = $("#hidIdLineaGrid").val();

        // define parámetros (json)
        params = {
            "idLinea": idLinea,
            "idAlarm": idAlarm,
            "timeOn": timeOn
        };

        // carga partial view en el diálogo
        CallBacks.loadPartialView(url, "POST", VerAlarmInfoDialog, params);
    }

    function VerAlarmInfoDialog(data) {
        // llena el div con el contenido devuelto por el partial view
        $("#divDialogAlarmInfo").html(data);

        // muestra el diálogo
        $("#divDialogAlarmInfo").dialog('open');
    }
</script>

    }
}

<script type="text/javascript">
    $(document).ready(function () {
        console.log("ready2!");

        // implementa dataTable
        $('#tbHistorical').dataTable({
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": '@Url.Action("List", "Alarm")',
            "bJQueryUI": false,
            "iDelay": 300,
            "bDeferRender": true,
            "bScrollInfinite": true,
            "bScrollCollapse": true,
            "iDisplayLength": $("#hidFiltroDisplayLengthGrid").val(),
            "bLengthChange": false,
            "aaSorting": [[2, 'desc']],
            "aoColumns": [
                { "bSearchable": false, "sWidth": "5%", "sName": "estado" },
                { "sWidth": "25%", "sName": "description" },
                { "sWidth": "13%", "sName": "timeOn" },
                { "sWidth": "13%", "sName": "timeOff" },
                { "sWidth": "13%", "sName": "timeAcknowledge" },
                { "sWidth": "13%", "sName": "timeReset" },
                { "sWidth": "13%", "sName": "timeQuarantine" },
                { "sWidth": "5%", "sName": "event" },
                { "bSearchable": false, "bVisible": false, "sName": "eventDescription" },
                { "bSearchable": false, "bVisible": false, "sName": "node" },
                { "bSearchable": false, "bVisible": false, "sName": "timeStampOn" },
                { "bSearchable": false, "bVisible": false, "sName": "idAlarm" }
            ],
            "oLanguage": {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ registros",
                "sZeroRecords": "No se encontraron resultados",
                "sEmptyTable": "Ningún dato disponible en esta tabla",
                "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix": "",
                "sSearch": "Buscar",
                "sUrl": "",
                "sInfoThousands": ",",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst": "Primero",
                    "sLast": "Último",
                    "sNext": "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            },
            "fnServerParams": function (aoData) {
                aoData.push({ "name": "cusIdLinea", "value": $("#hidIdLineaGrid").val() },
                            { "name": "cusDescription", "value": $("#hidFiltroDescripcionGrid").val() },
                            { "name": "cusDireccion", "value": $("#hidFiltroDireccionGrid").val() },
                            { "name": "cusSistema", "value": $("#hidFiltroSistemaGrid").val() },
                            { "name": "cusNode", "value": $("#hidFiltroNodeGrid").val() },
                            { "name": "cusInicio", "value": $("#hidFiltroDiaInicioGrid").val() },
                            { "name": "cusFin", "value": $("#hidFiltroDiaFinGrid").val() },
                            { "name": "cusCodigo", "value": $("#hidFiltroCodigoGrid").val() },
                            { "name": "cusShowEvents", "value": $("#hidEventosChckBx1Grid").val() },
                            { "name": "cusShowAusNoRec", "value": $("#hidEstadosChckBx1Grid").val() },
                            { "name": "cusShowPreNoRec", "value": $("#hidEstadosChckBx2Grid").val() },
                            { "name": "cusShowPreRec", "value": $("#hidEstadosChckBx3Grid").val() });
            },
            "sScrollY": $('.content-header').height(),
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                // verifica si tiene que recortar texto y aplicar tooltip
                if ($('td:eq(1)', nRow).text().length > 35) {
                    // define title para tooltip
                    $('td:eq(1)', nRow).attr('title', '<b>Descripción: </b></br>' + aData[1] + '</br></br><b>Causa: </b></br>' + aData[8]);
                    $('td:eq(1)', nRow).attr('class', 'Tooltip');

                    // recorta el texto
                    $('td:eq(1)', nRow).text($('td:eq(1)', nRow).text().substr(0, 35) + '...');

                    // define tooltip para la fila
                    $('td:eq(1)', nRow).tooltip({
                        show: {
                            effect: "slideDown",
                            delay: 250
                        },
                        hide: {
                            effect: "slideDown",
                            delay: 250
                        },
                        position: {
                            my: "left-50 center",
                            at: "right center"
                        }
                    });
                }

                // imagen para ausentes no reconocidas
                if ("" != aData[2] && "" != aData[3] && "" == aData[4]) {
                    $('td:eq(0)', nRow).html('<img style="cursor: pointer;" src="@Url.Content("~/Content/images/estados/est_rojo_m.gif")" />');
                }

                // imagen para presentes no reconocidas
                if ("" != aData[2] && "" == aData[3] && "" == aData[4]) {
                    $('td:eq(0)', nRow).html('<img style="cursor: pointer;" src="@Url.Content("~/Content/images/estados/est_azul_m.gif")" />');
                }

                // imagen para persentes reconocidas
                if ("" != aData[2] && "" == aData[3] && "" != aData[4]) {
                    $('td:eq(0)', nRow).html('<img style="cursor: pointer;" src="@Url.Content("~/Content/images/estados/est_verde_m.gif")" />');
                }

                // asigna llamada al diálogo
                $('td:eq(0)', nRow).on('click', function () {
                    VerAlarmInfo(aData[11], aData[2]);
                });
            },
            "fnDrawCallback": function (oSettings) {
                dataTableRezize();
            }
        });

        // aplica mejoras en la respuesta del filtro rapido
        $('#historical').dataTable().fnSetFilteringDelay();

        console.log("dialog!");

        // var isOpen = $( "#divDialogAlarmInfo" ).dialog( "isOpen" );

        if (dialogAlarmInfo != undefined){
            console.log("destroy!");
            $( "#divDialogAlarmInfo" ).dialog( "destroy" );
        }

        console.log(dialogAlarmInfo);

        // define dialogo para info de alarma
        dialogAlarmInfo = $("#divDialogAlarmInfo").dialog({
            autoOpen: false,
            width: "50%",
            modal: true,
            height: "auto",
            resizable: false,
            show: "slow"
        });

        console.log(dialogAlarmInfo);

    });
</script>